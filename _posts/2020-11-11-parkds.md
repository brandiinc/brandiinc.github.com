---
layout: post
cover: "/assets/default.jpg"
facebookImg: "/assets/kakao_log.png"
author: parkds
title: Scheduling SQS messages
---

## Overview

**ì˜¤ëŠ˜ì€ ë¸Œëœë””ì—ì„œ ì´ë¯¸ ì†Œê°œëœ ê¸°ìˆ ë“¤ì„ ê°„ë‹¨í•œ ë¯¸ì…˜ì„ í†µí•´ í™œìš©í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³¼ê¹Œ í•©ë‹ˆë‹¤.**

ë¸Œëœë””ëŠ” ìƒí’ˆ ì£¼ë¬¸ ë˜ëŠ” ì·¨ì†Œ, ë°°ì†¡ ìƒíƒœ ë“±ì— ë”°ë¼ ì‚¬ìš©ìì—ê²Œ ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€, SMS ë“± ê³ ê°ì—ê²Œ ì•Œë¦¼ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ, êµ­ë‚´ ì •ë³´í†µì‹ ë§ë²•ì— ë”°ë¼ ì•¼ê°„ ì‹œê°„ëŒ€(ì˜¤í›„ 9ì‹œ ~ ì˜¤ì „ 8ì‹œ ì‚¬ì´)ì—ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ì•Šì•„ì•¼ í•˜ë©°, ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ì„œëŠ” ë³„ë„ì˜ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. <a href="#link1" class="blue">[1]</a>

ê·¸ë ‡ë‹¤ë©´ ë‹¹ì¥ í•´ì•¼ í•  ë¯¸ì…˜ì— ëŒ€í•´ ì§ì‘ì´ ê°€ì‹œë‚˜ìš”?

<span class="blue">ë™ì˜ë¥¼ ë°›ì§€ ëª»í•œ ì•Œë¦¼ ì„œë¹„ìŠ¤ëŠ” ì•¼ê°„ ì‹œê°„ëŒ€ë¥¼ í”¼í•´ ì „ë‹¬í•˜ë¼.</span>

<span class="green">[ì‹œìŠ¤í…œ] ì§€ë ¹ì„ ìŠµë“í•˜ì˜€ìŠµë‹ˆë‹¤.</span>

<span class="red">ì‘?!?!</span>

{% include figure.html file="/assets/2020/20201111/01.png" alt="sqs" width="80" %}
<br /><br />

## Think

1. ëŒ€ëŸ‰ ë©”ì‹œì§€ ë°œì†¡ì„ ìœ„í•´ ì„œë²„ ë¶€í•˜ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ë³´ë‚´ê¸° ìœ„í•œ ì €ì¥ì†Œì™€ ì‹¤í–‰ìê°€ í•„ìš”í•©ë‹ˆë‹¤.

    âœ”ï¸  SQS + Lambda í¬ìŠ¤íŒ… ì°¸ê³  <a href="#link2" class="blue">[2]</a>

2. ì•¼ê°„ ì‹œê°„ëŒ€ì— ë³´ë‚¸ ë©”ì‹œì§€ ì €ì¥ì†Œì™€ ì´ ë©”ì‹œì§€ë“¤ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ì‹¤í–‰ìê°€ í•„ìš”í•©ë‹ˆë‹¤.

    âœ”ï¸  ì´ê²ƒë„ SQS + Lambda í¬ìŠ¤íŒ… ì°¸ê³  <a href="#link2" class="blue">[2]</a>

3. ì•¼ê°„ ì‹œê°„ëŒ€ì— ëª¨ì—¬ì§„ ë©”ì‹œì§€ë“¤ì„, ë§¤ì¼ í•´ë‹¹ ì‹œê°„ëŒ€ë¥¼ í”¼í•´ ì „ì†¡í•˜ê¸° ìœ„í•´ ì‰¬ì§€ ì•ŠëŠ” ê¸°ê³„ì™€ ë©”ì‹œì§€ ì „ì†¡ì„ ìœ„í•œ ì‹¤í–‰ìê°€ í•„ìš”í•©ë‹ˆë‹¤.

    âœ”ï¸ CloudWatch í¬ìŠ¤íŒ… ì°¸ê³  <a href="#link3" class="blue">[3]</a>

**í¬ìŠ¤íŒ…ì„ ì°¸ì¡°í•˜ì—¬ ê¸°ë³¸ì ìœ¼ë¡œ ìš”ì†Œë¥¼ êµ¬ì„± í–ˆë‹¤ë©´ ê·¸ë¦¼ì„ ê·¸ë¦¬ë©° í¼ì¦ì„ ë§ì¶”ì–´ ë´…ì‹œë‹¤.**
<br /><br />

## Architecture(Scedule Message SQS)

{% include figure.html file="/assets/2020/20201111/02.jpg" alt="sqs" width="80" %}

- ë¯¸ì…˜ì€ ì•¼ê°„ ì‹œê°„ëŒ€ë¥¼ í”¼í•´ ëŒ€ëŸ‰ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ì•¼ í•˜ë©°, ì´ë¯¸ ë¸Œëœë”” ì•Œë¦¼ ì„œë¹„ìŠ¤ì—ì„œ ì¡´ì¬í•˜ëŠ” ë‹¨ì¼ ì „ì†¡, ì¼ê´„ ì „ì†¡ ê¸°ëŠ¥ì— ìµœëŒ€í•œ ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.
- ì´ì— ë³„ë„ SQS(Schedule Message SQS)ë¥¼ êµ¬ì„±í•˜ì—¬ ê¸°ì¡´ SQSë¥¼ ë¶„ë¦¬ ì „ì†¡í•©ì‹œë‹¤.
<br /><br />

## Architecture(Wait Message SQS)

{% include figure.html file="/assets/2020/20201111/03.jpg" alt="sqs" width="80" %}

- ì•¼ê°„ ì‹œê°„ëŒ€ì— ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë³„ë„ ì €ì¥ì†Œì— ì €ì¥í•©ë‹ˆë‹¤.
- ì €ì¥ì†ŒëŠ” SQS ì™¸ Redis, Mongo DB ë“±ì„ ì´ìš©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.
- ë‹¤ë§Œ, í•„ìì˜ ê²½ìš° SQSê°€ ì›¹ UI ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ê°„í¸í•˜ë©° ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜ ì²˜ë¦¬ ë“±ì„ ì†ì‰½ê²Œ ì„¤ì • ê°€ëŠ¥í•˜ë©°, ë©”ì‹œì§€ ë³´ê´€ ë“±ì„ ë¹„ì¤‘ ìˆê²Œ ìƒê°í•˜ì—¬ ì„ íƒí–ˆìœ¼ë‹ˆ ìƒí™©ì— ë§ê²Œ ì„ íƒí•˜ì‹œë©´ ë©ë‹ˆë‹¤. ğŸ™‚
<br /><br />

## Architecture(Scheduling SQS messages)

{% include figure.html file="/assets/2020/20201111/04.jpg" alt="sqs" width="80" %}

- ì•ì„œ êµ¬ì„±í•œ ê¸°ê³„(Cloud Watch)ì™€ ì‹¤í–‰ì(Schedule Lambda)ë¡œ SQSì— ìŒ“ì¸ ë©”ì‹œì§€ë“¤ì„ ì¡°ê¸ˆì”© ê°€ì ¸ì™€ Schedule Message SQSì— ë©”ì‹œì§€ë“¤ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
- í•˜ë‚˜ì˜ SQSë¥¼ êµ¬ì„±í•˜ì—¬ ë©”ì‹œì§€ ì „ì†¡ì„ í•´ë„ ë˜ê³ , ë©”ì‹œì§€ ì „ì†¡ ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ ê¸°ì¡´ SQSë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ë³„ë„ì˜ SQSë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒë„ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

**í¼ì¦ì„ ë§ì¶”ì—ˆë‹¤ë©´ ì´ì œ ì½”ë“œë¥¼ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.**
<br /><br />

## Code

- scedule_manager/main.py : ìŠ¤ì¼€ì¤„ëŸ¬ ë©”ì¸

```python
# -*- coding: UTF-8 -*-
# from module.order_message import OrderMessage
# from module.refund_message import RefundMessage
# from module.delivery_message import DeliveryMessage
from module.wait_message import WaitMessage

import json

sqs_list = [
    # OrderMessage(),
    # RefundMessage(),
    # DeliveryMessage()
    WaitMessage()
]


def handle():

    send_result_map = {}

    for sqs in sqs_list:
        send_result_map[sqs.name()] = sqs.send()

    return json.dumps(send_result_map)
```
<br />

- scedule_manager/test.py : í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„œë²„ êµ¬ë™

```python
# -*- coding: UTF-8 -*-
"""
Examples:
    # ì„œë²„ êµ¬ë™
    python ./test.py
    # í…ŒìŠ¤íŠ¸ ë©”ì„¸ì§€ ì „ì†¡
    http://localhost:5000/send ì— POSTë¡œ SQSì— ë„£ì„ ë©”ì„¸ì§€ ì „ì†¡
"""
from flask import Flask
import main

app = Flask(__name__)


@app.route('/test', methods=['GET'])
def send():
    return main.handle()


if __name__ == '__main__':
    app.run(debug=True, port=5000
```
<br />

- scedule_manager/requirements.txt : install í•­ëª©

```
pymysql
jinja2
pytz
requests
slacker
boto3
Flask
```
<br />

- ê³µí†µ
<span class="indent">- scedule_manager/common/constant.py : ì „ì—­ë³€ìˆ˜</span>

```python
# -*- coding: utf-8 -*-
# ìŠ¤ì¼€ì¤„ëŸ¬ ë©”ì‹œì§€ ì¼ê´„ ì „ì†¡ SQS
SQS_QUEUE_URL_SCEDULE = 'https://sqs.ap-northeast-1.amazonaws.com/9999999999/sqs_scedule_message'
# ì•¼ê°„ ì‹œê°„ëŒ€ì— ì „ì†¡ëœ ë©”ì‹œì§€ ì €ì¥ì†Œ SQS
SQS_QUEUE_URL_WAIT = 'https://sqs.ap-northeast-1.amazonaws.com/9999999999/sqs_wait_message'

SLACK_TOKEN = 'xoxp-9999999999-9999999999-9999999999-999999999999999999999999999999'
```
<br />

- ëª¨ë“ˆ
<span class="indent">- scedule_manager/module/wait_message.py : ëŒ€ê¸° ë©”ì‹œì§€ ì „ì†¡ SQS ëª¨ë“ˆ</span>

```python
# -*- coding: UTF-8 -*-
import json

from common import constant
from utils import schedule, slack, sqs


#############################
# ëŒ€ê¸° ë©”ì‹œì§€ ì „ì†¡ SQS ëª¨ë“ˆ
#############################
class WaitMessage:
    schedule = {
        '08:00': {'usePeriod': True}
    }

    # ì´ë¦„
    def name(self):
        return 'WaitMessage SQS'

    # ì „ì†¡
    def send(self):
        print('=' * 30)
        print('WaitMessage SQS Send Message!')
        print('=' * 30)

        # ìŠ¤ì¼€ì¤„ ì‹œê°„ í™•ì¸
        schedule_info = schedule.get_schedule_info(self.schedule)

        if schedule_info.get('result'):

            total = 0

            try:
                # ì¬ì „ì†¡ SQSì— íê°€ ë¹„ì›Œì§ˆë•Œê¹Œì§€ êº¼ë‚´ê³  SQS ë©”ì„¸ì§€ ì „ì†¡ í›„ ë©”ì„¸ì§€ ì‚­ì œ
                for message in sqs.receive_after_delete(constant.SQS_QUEUE_URL_WAIT):
                    if message['Body']:
                        sqs.send(constant.SQS_QUEUE_URL_SCEDULE, (json.dumps(message['Body'])))
                        total += 1
            except Exception as e:
                print("SQS Fail : {}".format(e))
                slack.send_slack_message('Exception: {}'.format(str(e)), 'SQS Fail!')

            return {
                'result': True, 'total': total,
            }

        else:  # ì‹¤íŒ¨ì‹œ ì‹¤íŒ¨ ë©”ì‹œì§€ ë¦¬í„´
            return schedule_info.get('message')
```
<br />

- ìœ í‹¸
<span class="indent">- scedule_manager/utils/schedule.py : Util Schedule</span>

```python
# -*- coding: UTF-8 -*-
import datetime
from pytz import timezone


def get_schedule_info(schedule):
    """ìŠ¬ë™ ë©”ì„¸ì§€ ì „ì†¡

    Args:
        schedule: json

    Returns:
        json

    """
    # now_date = datetime.datetime.now(timezone('Asia/Seoul'))  # í˜„ì¬ì‹œê°„
    now_date = datetime.datetime(2020, 9, 29, 8, 0, 0, 0)  # í…ŒìŠ¤íŠ¸ ì‹œê°„ì„¤ì •

    refine_date = datetime.datetime(now_date.year, now_date.month, now_date.day, now_date.hour, 0, 0, 0)  # ì •ë¦¬ëœ ì‹œê°„
    limit_date = datetime.datetime(now_date.year, now_date.month, now_date.day, now_date.hour, 5, 0, 0)  # ìœ íš¨ ì‹œê°„

    result = {
        "now_date": now_date.strftime("%Y-%m-%d %H:%M:%S"),
        "refine_date": refine_date.strftime("%Y-%m-%d %H:%M:%S"),
        "limit_date": limit_date.strftime("%Y-%m-%d %H:%M:%S")
    }

    # ìœ íš¨ ì‹œê°„ ë„˜ì–´ê°€ë©´
    if now_date.time() > limit_date.time():
        startTime = refine_date.strftime("%Y-%m-%d %H:%M:%S")
        endTime = limit_date.strftime("%Y-%m-%d %H:%M:%S")
        result.update({"result": False, "message": "ìœ íš¨ì‹œê°„ ë²”ìœ„ [" + startTime + " ~ " + endTime + "] ì´ˆê³¼"})
    # ìœ íš¨ ì‹œê°„ ì •ë³´ê°€ ì—†ìœ¼ë©´
    elif schedule.get(refine_date.strftime("%H:%M")) is None:
        result.update({"result": False, "message": "no match schedule"})
    # ì„±ê³µ
    else:
        result.update({"result": True})

        if schedule.get("usePeriod"):
            schedule_info = schedule.get(refine_date.strftime("%H:%M"))
            result.update({"result": True, "info": schedule_info})

    return result
```
<br />

<span class="indent2">- scedule_manager/utils/slack.py : Util Slack</span>

```python
# -*- coding: UTF-8 -*-
from slacker import Slacker
from common import constant


def send_slack_message(message, title, incoming_webhook_url='https://hooks.slack.com/services/TEST'):
    """ìŠ¬ë™ ë©”ì„¸ì§€ ì „ì†¡

    Args:
        incoming_webhook_url: slack webhook url
        message: ì „ë‹¬í•  ë©”ì„¸ì§€
        title: ë©”ì‹œì§€ íƒ€ì´í‹€ ì´ë¦„

    Returns:
        response or False

    """
    token = constant.SLACK_TOKEN

    slack = Slacker(
        token=token,
        incoming_webhook_url=incoming_webhook_url,
        timeout=300
    )
    attachments = list()
    attachment = {
        'title': title,
        'fields': [
            {
                'value': message,
                'short': False
            }
        ],
        'mrkdwn_in': ['text', 'title', 'fields']
    }

    attachments.append(attachment)
    slack_data = {
        'attachments': attachments
    }

    return slack.incomingwebhook.post(slack_data)
```
<br />

<span class="indent2">- scedule_manager/utils/sqs.py : Util SQS</span>

```python
# -*- coding: UTF-8 -*-
import boto3

def send(queue_url, body):
    """SQS ë©”ì„¸ì§€ ì „ì†¡

    Args:
        queue_url: SQS URL
        body : ì „ë‹¬í•  SQS Body

    Returns:
        response or False
    """
    sqs_client = boto3.client('sqs', 'ap-northeast-1')

    response = sqs_client.send_message(
        QueueUrl=queue_url,
        MessageBody=body
    )
    return response


def receive_after_delete(queue_url):
    """ì¬ì „ì†¡ SQSì— íê°€ ë¹„ì›Œì§ˆë•Œê¹Œì§€ êº¼ë‚´ê³  ë©”ì„¸ì§€ ì‚­ì œ

    Args:
        queue_url: SQS URL

    Returns:
        response or False
    """

    sqs_client = boto3.client('sqs', 'ap-northeast-1')

    while True:
        resp = sqs_client.receive_message(
            QueueUrl=queue_url,
            AttributeNames=['All'],
            MaxNumberOfMessages=10
        )

        try:
            yield from resp['Messages']
        except KeyError:
            return False

        entries = [
            {'Id': msg['MessageId'], 'ReceiptHandle': msg['ReceiptHandle']}
            for msg in resp['Messages']
        ]

        resp = sqs_client.delete_message_batch(
            QueueUrl=queue_url, Entries=entries
        )

        if len(resp['Successful']) != len(entries):
            raise RuntimeError(
                f"Failed to delete messages: entries={entries!r} resp={resp!r}"
            )
```
<br /><br />

**ì—¬ê¸°ì„œ ì ê¹! ì¶”ê°€ë¡œ í’€ì–´ë‚˜ê°€ì•¼ í•  ê³¼ì œê°€ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤!**

ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ê³ ê°ì´ ë§ì•„ì§€ë©´ í•œë²ˆì— ì „ì†¡í•´ì•¼ í•˜ëŠ” Wait Message SQSë„ ê·¸ë§Œí¼ ëŠ˜ì–´ë‚˜ê²Œ ë©ë‹ˆë‹¤. ë¬¼ë¡  Schedule Lambda ì œí•œ ì‹œê°„ ì•ˆì— ì™„ë£Œëœë‹¤ë©´ ë¬¸ì œê°€ ì—†ìœ¼ë‚˜, ì´ˆê³¼í•  ê²½ìš° ë‚¨ì•„ ìˆëŠ” MessageëŠ” ì–´ë–»ê²Œ í• ì§€ì— ëŒ€í•œ ê³ ë¯¼í•˜ê²Œ ë©ë‹ˆë‹¤. ê¸€ ì¤‘ê°„ì— ë©”ì‹œì§€ ì „ì†¡ ì†ë„ì— ëŒ€í•´ ì–¸ê¸‰í•˜ì—¬ ê·¸ëŸ¬í•œ ì¼ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ SQS ì¶”ê°€ êµ¬ì„±ì— ëŒ€í•´ ë§ì”€ë“œë ¸ëŠ”ë°ìš”. 'ë‚˜ëŠ” ì œí•œ ì‹œê°„ì— ì–½ë§¤ì´ëŠ” ê²Œ ì‹«ë‹¤!' í•˜ì‹œëŠ” ë¶„ë“¤ì€ Batch êµ¬ì„±ì„ í•œë‹¤ë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
<br /><br />

## Conclusion

ì´ë²ˆ ì‹œê°„ì—ëŠ” Schedulingì„ í†µí•´ SQS ë©”ì‹œì§€ë¥¼ ëª¨ì•˜ë‹¤ê°€ ë‹¤ë¥¸ SQSë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì•„ì§ ê³ ë¯¼í•´ì•¼ í•  ì‚¬í•­ë“¤ì€ ì¡´ì¬í•˜ì§€ë§Œ, íŠ¹ì • ì¼ìì— ì „ë‹¬í•´ì•¼ í•˜ëŠ” ë°ì´í„°ë¥¼ ì‰½ê³  ë¹ ë¥´ê²Œ, ë”ë¶ˆì–´ ìœ ì§€ë³´ìˆ˜ë„ í¸í•˜ë„ë¡ ê°œë°œí•´ì•¼ í•  ë•Œ Amazon SQSë¥¼ ì´ìš©í•œ Scheduling ë°©ë²•ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.ğŸ™‚
<br /><br />

## Reference

<a name="link1"></a>
1\. ë¶ˆë²•ìŠ¤íŒ¸ëŒ€ì‘ì„¼í„° - ì•¼ê°„ì‹œê°„ëŒ€ì— ê´‘ê³ ì„± ì •ë³´ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆëŠ”ì§€?<br />
<a href="https://spam.kisa.or.kr/customer/sub3_R.do?idx=8" class="indent">https://spam.kisa.or.kr/customer/sub3_R.do?idx=8</a>

<a name="link2"></a>
2\. SQS + Lambda - ì´ìƒê·¼ ì‹¤ì¥ë‹˜ ì‘ì„± ê¸€<br />
<a href="http://labs.brandi.co.kr/2018/02/16/leesg.html" class="indent">http://labs.brandi.co.kr/2018/02/16/leesg.html</a>

<a name="link3"></a>
3\. CloudWatchì— ëŒ€í•˜ì—¬ - ê³½ì •ì„­ë‹˜ ì‘ì„± ê¸€<br />
<a href="http://labs.brandi.co.kr/2019/05/30/kwakjs.html" class="indent">http://labs.brandi.co.kr/2019/05/30/kwakjs.html</a>
