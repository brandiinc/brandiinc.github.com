---
layout: post
cover: "/assets/default.jpg"
facebookImg: "/assets/kakao_log.png"
author: kwakjs
title: AWS CloudFront + Lambda@Edge ë¡œ HTTP ìš”ì²­ ì‹œ íŠ¹ì • í—¤ë”ì— ì ‘ê·¼ ì œì–´ ì¶”ê°€í•˜ê¸°
---

# Overview

ì™¸ë¶€ì— HTTP ìš”ì²­ìœ¼ë¡œ ìì› ê³µìœ  ì‹œ ë³´ì•ˆì— íŠ¹íˆ ì‹ ê²½ì„ ì¨ì•¼ í•©ë‹ˆë‹¤. AWS CloudFront + Lambda@Edge ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ë©´ HTTP ìš”ì²­ ì‹œ ì‚¬ìš©ì ì§€ì • í•¨ìˆ˜ë¡œ ì›í•˜ëŠ” ëª©ì ì— ë”°ë¼ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.


ì´ë²ˆ ê¸€ì—ì„œëŠ” ì˜¤ë¦¬ì§„ ì„œë²„ì—ê²Œ ìš”ì²­ ì‹œ í—¤ë”ì— Authorization Key ê°’ì„ ì¶”ê°€í•˜ì—¬ ì¸ì¦ì„ í†µí•´ íŠ¹ì • ì‚¬ìš©ìë§Œ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ì¶”ê°€í•´ë³´ê² ìŠµë‹ˆë‹¤.
<br /><br />

## **ì‘ì—… ì§„í–‰ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.**

1. Origin Server ìƒì„±
2. CloudFront ìƒì„±
3. CloudFront ì˜¤ë¥˜ ì‘ë‹µ ì„¤ì •
4. CloudFront ì´ë²¤íŠ¸ì— ì˜í•œ Lambda@Edge íŠ¸ë¦¬ê±°
5. Route 53 ë„ë©”ì¸ ì—°ê²°


1\. Origin Server ìƒì„±
<span class="indent">AWS S3 Bucketì„ Origin Serverë¡œ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.</span>


<span class="indent">1) AWS S3 Bucket ìƒì„±</span>

{% include figure.html file="/assets/20200120/01.png" alt="edge" width="fitcontent" %}

<span class="indent2">- AWS S3 Bucketì— ê³„ì¸µì„ ë§Œë“¤ì–´ ì´ë¯¸ì§€ íŒŒì¼ ì €ì¥</span>
<span class="indent2">- CloudFrontì—ì„œ ì œê³µí•˜ë ¤ëŠ” ëª¨ë“  ê°ì²´ë¥¼ AWS S3 Bucketì— ë°°ì¹˜</span>
<span class="indent2">- AWS S3 Bucket í•´ë‹¹ ìì›ì— ëŒ€í•œ GetObject ì •ì±… ì¶”ê°€</span>

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::dev-kwakjs-test/ex-img/*"
        }
    ]
}
```
<br />

2\. CloudFront ìƒì„±

<span class="indent">AWS CloudFrontëŠ” ì½˜í…ì¸ ë¥¼ ì‚¬ìš©ìì—ê²Œ ë¹ ë¥´ê³  ì•ˆì „í•˜ê²Œ ì „ì†¡í•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</span>

<span class="indent">1) Distributions WEB (HTTPí†µì‹ ) ì„ íƒ</span>

{% include figure.html file="/assets/20200120/02.png" alt="edge" width="fitcontent" %}

<span class="indent">2) Origin Server ì„¤ì •</span>

{% include figure.html file="/assets/20200120/03.png" alt="edge" width="fitcontent" %}

<span class="indent2">- Origin Domain Name : ëŒ€ìƒ S3 Bucket</span>
<span class="indent2">- Origin Path : ê¸°ë³¸ ê²½ë¡œ ì§€ì • (ex-img/)</span>


<span class="indent3">ğŸ’¡*ì´ë²ˆ ê¸€ì—ì„œëŠ” íŠ¹ì •í•œ ìµœì¢… ì‚¬ìš©ìì—ê²Œ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ìš©ë„ì´ê¸° ë•Œë¬¸ì— ê¶Œí•œì´ í•„ìš”í•œ S3 ê²½ë¡œ íŒ¨í„´ì„ ëª…í™•í•˜ê²Œ ì§€ì •í•˜ì—¬ "ex-img/\*" ì— ì ‘ê·¼í•  ë•Œë§Œ Lambda@Edge í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë„ë¡ í•˜ì—¬ ë¹„ìš©ì„ ì ˆê°í•©ë‹ˆë‹¤.*</span>

<span class="indent">3) CloudFront Distributions WEB ìƒì„±</span>

<span class="indent2">ë°°í¬ê¹Œì§€ 10~15ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</span>

<span class="indent2">- ë°°í¬ ì „</span>

{% include figure.html file="/assets/20200120/04.png" alt="edge" width="fitcontent" %}

<span class="indent2">- ë°°í¬ í›„</span>

{% include figure.html file="/assets/20200120/05.png" alt="edge" width="fitcontent" %}
<br />

3\. CloudFront ì˜¤ë¥˜ ì‘ë‹µ ì„¤ì •

<span class="indent">Lambda@Edge í•¨ìˆ˜ ì‹¤í–‰ í›„ HTTP 4xx ë˜ëŠ” 5xx ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•  ë•Œ CloudFrontì—ì„œ ìµœì¢… ì‚¬ìš©ìì—ê²Œ ë°˜í™˜í•˜ë ¤ëŠ” ì‚¬ìš©ì ì§€ì • ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>

{% include figure.html file="/assets/20200120/06.png" alt="edge" width="fitcontent" %}

<span class="indent">- 403 ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•  ê²½ìš° ê¸°ë³¸ XML í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ</span>


<span class="indent">1) 403-response.json íŒŒì¼ ìƒì„±</span>

```json
{"meta": {"code": 403, "error_message": "Forbidden"}, "data": {}}
```


<span class="indent">2) S3 Bucket ê¸°ë³¸ê²½ë¡œ í•˜ìœ„ í´ë”ì— ì—…ë¡œë“œ</span>

{% include figure.html file="/assets/20200120/07.png" alt="edge" width="fitcontent" %}


<span class="indent">3) Error Pages ìƒì„± Step-1</span>

{% include figure.html file="/assets/20200120/08.png" alt="edge" width="fitcontent" %}


<span class="indent">4) Error Pages ìƒì„± Step-2</span>

{% include figure.html file="/assets/20200120/09.png" alt="edge" width="fitcontent" %}

<span class="indent2">- S3 Bucket ì— ì—…ë¡œë“œí•œ ì—ëŸ¬ í˜ì´ì§€ ê²½ë¡œ ì¶”ê°€</span>


<span class="indent">5) Error Pages ìƒì„± Step-3</span>

{% include figure.html file="/assets/20200120/10.png" alt="edge" width="fitcontent" %}

<span class="indent2">- í•„ìš”í•œ ì˜¤ë¥˜ ìƒíƒœì— ëŒ€í•œ ì‚¬ìš©ì ì§€ì • ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.</span>
<span class="indent2">- í˜„ì¬ CloudFront ì—ì„œ ì‚¬ìš©ì ì§€ì • ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆëŠ” HTTP ìƒíƒœ ì½”ë“œì…ë‹ˆë‹¤.</span>
<span class="indent3">- 400, 403, 404, 405, 414, 416</span>
<span class="indent3">- 500, 501, 502, 503, 504</span><br />


<span class="indent">6) JSON í˜•ì‹ì˜ ì˜¤ë¥˜ ì‘ë‹µ í™•ì¸</span>

{% include figure.html file="/assets/20200120/11.png" alt="edge" width="fitcontent" %}<br />
<br />

4\. CloudFront ì´ë²¤íŠ¸ì— ì˜í•œ Lambda@Edge íŠ¸ë¦¬ê±°

<span class="indent">CloudFrontë¡œ ìƒì„±ëœ 4ê°€ì§€ ì´ë²¤íŠ¸ ì‹œì ì— Lambda@Edge í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ ìš”êµ¬ ì‚¬í•­ì— ë§ê²Œ ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>


<span class="indent">1) CloudFrontë¡œ ìƒì„±ëœ 4ê°€ì§€ ì´ë²¤íŠ¸</span>

{% include figure.html file="/assets/20200120/12.png" alt="edge" width="fitcontent" %}

<span class="indent2">(1) Viewer Request</span>

<span class="indent3">- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì´ë²¤íŠ¸ê°€ ë„ì°©í•˜ê³  ë“¤ì–´ì˜¤ëŠ” HTTP ìš”ì²­ì— ì ‘ê·¼í•  ë•Œ ë™ì‘</span>
<span class="indent3">- ì´ íŠ¹ì • ì´ë²¤íŠ¸ëŠ” ìš”ì²­ëœ ê°œì²´ê°€ ì´ë¯¸ ìºì‹œë˜ì–´ ìˆëŠ”ì§€ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ë™ì‘</span>

<span class="indent2">(2) Origin Request</span>

<span class="indent3">- ìš”ì²­ëœ ê°ì²´ê°€ ì—£ì§€ ë¡œì¼€ì´ì…˜ì— ìºì‹œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì—ë§Œ ë™ì‘</span>

<span class="indent2">(3) Origin Response</span>

<span class="indent3">- ì˜¤ë¦¬ì§„ì´ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°˜í™˜í•œ í›„ì— ë™ì‘</span>

<span class="indent2">(4) Viewer Response</span>

<span class="indent3">- ì—£ì§€ ë¡œì¼€ì´ì…˜ ë·°ì–´ì— ì‘ë‹µì„ ë°˜í™˜í•˜ê¸° ì „ì— ì´ë²¤íŠ¸ê°€ ë™ì‘</span>

<span class="indent3">ğŸ’¡*ìš”ì²­ëœ ê°œì²´ê°€ ìºì‹œ ìƒì„± ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ëª¨ë“  ìš”ì²­ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•´ì„œ Viewer Request ì´ë²¤íŠ¸ ì‹œì ì— ë¡œì§ì„ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤.*</span><br />


<span class="indent">2) Lambda@Edge í•¨ìˆ˜ ì¶”ê°€</span>

<span class="indent2">ì„œë²„ ê´€ë¦¬ ë¶€ë‹´ ì—†ì´ ì „ ì„¸ê³„ì ìœ¼ë¡œ ë¹ ë¥´ê²Œ ë°°í¬ ê°€ëŠ¥í•˜ë©°, User-Agent í—¤ë”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŠ¹ì • ê°ì²´ë¥¼ ì‚¬ìš©ìì—ê²Œ ì „ì†¡ ë° íŠ¹ì • í—¤ë”ì— ëŒ€í•œ ì ‘ê·¼ ì œì–´ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ìœ ìš©í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</span>


<span class="indent2">íŠ¹ì • í—¤ë”ì— ì¸ì¦ì„ ì¶”ê°€í•˜ì—¬ ì‘ë‹µ í—¤ë” ê°’ì„ ì¬ì •ì˜í•˜ëŠ” Lambda@Edge í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤.</span><br />


<span class="indent2">(1) Python ì†ŒìŠ¤ ì½”ë“œ</span>

```python
# -*- coding: UTF-8 -*-
import json
import logging

logging.getLogger().setLevel(logging.INFO)


def _generate_change_request_info():
    """
    ë³€ê²½í•  ìš”ì²­ ì •ë³´ ìƒì„±

    401 ìƒíƒœ ë³€ê²½ì¼ ê²½ìš°ë§Œ ì²˜ë¦¬

    Returns:
        dict: request (ìš”ì²­ë°ì´í„°)
    """

    headers_request = {
        'cache-control': [
            {
                'key': 'Cache-Control',
                'value': 'no-cache',
            }
        ],
        'content-type': [
            {
                'key': 'Content-Type',
                'value': 'application/json',
            }
        ]
    }

    # ë³€ê²½í•  ìƒíƒœ ì •ë³´
    change_status_value = 401
    change_status_description = 'Unauthorized'

    add_meta_dict = {
        'code': change_status_value,
        'error_message': change_status_description,
    }

    body_request_dict = {
        'meta': add_meta_dict,
        'data': {},
    }

    body_request_json = json.dumps(body_request_dict)

    request_dict = {
        'headers': headers_request,
        'status': change_status_value,
        'statusDescription': change_status_description,
        'body': body_request_json,
    }

    return request_dict


def lambda_handler(event, context):
    """
    CloudFront ViewerRequest ì´ë²¤íŠ¸ì²˜ë¦¬

    í—¤ë”ì— Authorization Key ê°’ìœ¼ë¡œ ì ‘ê·¼ê¶Œí•œ ì¶”ê°€

    Returns:
        dict: request (ìš”ì²­ë°ì´í„°)
    """

    logging.info('event::{}'.format(event))

    try:
        request_dict = event.get('Records')[0].get('cf').get('request')

        # í—¤ë”ì— Authorization Key ê°’ìœ¼ë¡œ ì ‘ê·¼ ì—¬ë¶€ í™•ì¸
        auth_key = request_dict.get('headers').get('authorization')[0]['value']

        if auth_key != 'brandi.token':
            logging.warning('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼')

            # ë³€ê²½í•  ìš”ì²­ ì •ë³´ ìƒì„± (401)
            request_dict = _generate_change_request_info()

    except Exception as e:
        logging.error('exception::{1}'.format(e.args[0], e))

        return {
            'status': 500,
            'statusDescription': 'Internal server error',
        }

    logging.info('request_dict::{}'.format(request_dict))

    return request_dict
```

ğŸ’¡*ì˜¤ë¥˜ ì‘ë‹µ ì„¤ì • ì‹œ '401' ìƒíƒœì— ëŒ€í•œ ì‚¬ìš©ì ì§€ì • ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ë°˜í™˜í•  ìˆ˜ ì—†ì–´, ì˜¤ë¥˜ ìƒíƒœ '401' ê²½ìš°ì—ë§Œ Body í•­ëª©ì— Json í˜•íƒœë¡œ ì¬ì •ì˜í•˜ì—¬ ì‘ë‹µ ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤.*<br /><br />


<span class="indent2">(2) Lambda@Edge ì„¤ì •</span>

{% include figure.html file="/assets/20200120/13.png" alt="edge" width="fitcontent" %}

<span class="indent3">1. ë²„ì§€ë‹ˆì•„ ë¦¬ì „ì—ì„œë§Œ Lambda@Edge ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
<span class="indent3">2. ëŸ°íƒ€ì„ì€ Node.js 10.x, Node.js 8.10, Python 3.7 ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.</span>
<span class="indent3">3. ì´ ì—­í• ì—ëŠ” AWS CloudWatch Logsì— ë¡œê·¸ë¥¼ ì—…ë¡œë“œ í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</span>
<span class="indent3">4. Memory 128MB ì´ë‚´ë¡œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
<span class="indent3">5. Viewer Request, Viewer Response ì´ë²¤íŠ¸ëŠ” ì‹¤í–‰ì‹œê°„ 5ì´ˆ ì´ë‚´ë¡œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</span><br />


<span class="indent2">(3) Lambda@Edge ë°°í¬</span>

{% include figure.html file="/assets/20200120/14.png" alt="edge" width="fitcontent" %}<br />


<span class="indent2">(4) ë²„ì „ ê²Œì‹œ (CloudFront Event ì—°ê²°)</span>

{% include figure.html file="/assets/20200120/15.png" alt="edge" width="fitcontent" %}

<span class="indent3">- Distribution : CloudFront Distribution ì„ íƒ</span>
<span class="indent3">- CloudFront Event : Viewer Request ì„ íƒ</span><br />


<span class="indent2">(5) Lambda@Edge í•¨ìˆ˜ ìƒì„±</span>

<span class="indent3">ë°°í¬ê¹Œì§€ 10~15ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</span>


<span class="indent3">- ë°°í¬ ì „</span>

{% include figure.html file="/assets/20200120/16.png" alt="edge" width="fitcontent" %}


<span class="indent3">- ë°°í¬ í›„</span>

{% include figure.html file="/assets/20200120/17.png" alt="edge" width="fitcontent" %}
<br />

<span class="indent2">(6) ê²°ê³¼ í™•ì¸</span>
<span class="indent3">- Authorization ë¯¸ì¸ì¦</span>

{% include figure.html file="/assets/20200120/18.png" alt="edge" width="fitcontent" %}

<span class="indent4">- ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì¼ ê²½ìš° ì˜¤ë¥˜ ì½”ë“œ '401' ì‘ë‹µ ë°ì´í„° ë°˜í™˜ë©ë‹ˆë‹¤.</span><br />


<span class="indent3">- Authorization ì¸ì¦</span>

{% include figure.html file="/assets/20200120/19.png" alt="edge" width="fitcontent" %}

<span class="indent4">- ì¸ì¦ëœ ì •ìƒì ì¸ ì ‘ê·¼ì¼ ê²½ìš° ìš”ì²­í•œ ì»¨í…ì¸ ê°€ ë³´ì—¬ì§‘ë‹ˆë‹¤.</span>
<br />

5\. Route 53 ë„ë©”ì¸ ì—°ê²°

<span class="indent">Route 53 ëŠ” ê°€ìš©ì„±ê³¼ í™•ì¥ì„±ì´ ë›°ì–´ë‚œ í´ë¼ìš°ë“œ DNS ì›¹ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë“±ë¡ëœ ë„ë©”ì¸ì— ë ˆì½”ë“œë¥¼ ì¶”ê°€ í›„ CloudFront CNAME ìœ¼ë¡œ ë§¤í•‘í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë  ë„ë©”ì¸ì„ ì—°ê²°í•˜ê² ìŠµë‹ˆë‹¤.</span><br />


<span class="indent">ë„ë©”ì¸ ë“±ë¡ì€ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.</span><br />


<span class="indent">1) CloudFront CNAME ì¶”ê°€</span>

{% include figure.html file="/assets/20200120/20.png" alt="edge" width="fitcontent" %}

<span class="indent2">- Route 53ë¡œ ë“±ë¡ëœ ë„ë©”ì¸ì„ CloudFront CNAME ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.</span><br />


<span class="indent">2) CloudFront CNAME ì¶”ê°€ í™•ì¸</span>

{% include figure.html file="/assets/20200120/21.png" alt="edge" width="fitcontent" %}<br />


<span class="indent">3) Route 53 ë ˆì½”ë“œ ì¶”ê°€</span>

{% include figure.html file="/assets/20200120/22.png" alt="edge" width="70" %}

<span class="indent2">- ë°°í¬ëœ CloudFront Domain Nameìœ¼ë¡œ Targetì„ ì„ íƒí•©ë‹ˆë‹¤.</span><br />


<span class="indent">4) ë„ë©”ì¸ ì—°ê²° í™•ì¸</span>

{% include figure.html file="/assets/20200120/23.png" alt="edge" width="fitcontent" %}<br />


# Conclusion

AWS CloudFront + Lambda@Edge ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ HTTP ìš”ì²­ ì‹œ ê¶Œí•œì„ ì¶”ê°€í•˜ì—¬ íŠ¹ì • ì‚¬ìš©ìë§Œ ìì›ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.<br />
ê·¸ ì™¸ì—ë„ Lambda@Edge í•¨ìˆ˜ë¡œ ì§€ëŠ¥ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ì˜ˆì œê°€ AWS ê°œë°œì ì•ˆë‚´ì„œì— ì„¤ëª…ë˜ì–´ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ë©´ ë  ê±° ê°™ìŠµë‹ˆë‹¤.<br /><br />

## ì°¸ê³  ìë£Œ

[https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-examples.html](https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-examples.html)
