---
layout: post
cover: "/assets/default.jpg"
facebookImg: "/assets/kakao_log.png"
author: kimwk
title: ì¶”ì²œ ì‹œìŠ¤í…œ ë§›ë³´ê¸° - AWS SageMakerë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ
subtitle: ì£½ëŠ” ì¤„ ì•Œì•˜ìŠµë‹ˆë‹¤.
---

**ëª©ì°¨**<br />
<a href="#link1">1.</a> INTRO<br />
<a href="#link2">2.</a> CHAPTER 1<br />
<span class="indent"><a href="#link3">1.</a> The Recommendation Problem</span>
<span class="indent"><a href="#link4">2.</a> ëª…ì‹œì  ì ìˆ˜(Explicit Rating)</span>
<span class="indent"><a href="#link5">3.</a> ì•”ë¬µì  í”¼ë“œë°±(Implicit Feedback)</span>
<span class="indent"><a href="#link6">4.</a> ë¸Œëœë”” ì„œë¹„ìŠ¤ ì† ëª…ì‹œì  ì ìˆ˜ì™€ ì•”ë¬µì  í”¼ë“œë°±</span>
<a href="#link7">3.</a> CHAPTER 2<br />
<span class="indent"><a href="#link8">1.</a> ì˜ˆì œ ì‹¤ìŠµ</span>
<a href="#link9">4.</a> CONCLUSION<br />

---

<a name="link1"></a>
## INTRO

ì§€ë‚œ 10ì›”, ë¸Œëœë”” ë©ìŠ¤ì— 'ê°œë°œ 1íŒ€ì˜ AWS Personalize ë„ì „ê¸°' ë¥¼ ê²Œì¬í•˜ë©´ì„œ í•˜ë‚˜ì˜ ë¯¸ì…˜ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ë°”ë¡œ AWS SageMaker(ì´í•˜ SageMaker)ë¥¼ ì´ìš©í•´ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ì„ ë‹¤ë¤„ë³´ëŠ” ê²ƒì´ì—ˆëŠ”ë°ìš”. ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ëª¨ë¥´ë©´ AWS RDSë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë µë“¯ì´, ë¨¸ì‹ ëŸ¬ë‹ì— ëŒ€í•´ ëª¨ë¥´ëŠ” ìƒíƒœì—ì„œëŠ” SageMakerë¥¼ ë‹¤ë£¨ê¸°ê°€ ë§¤ìš° ì–´ë ¤ì› ìŠµë‹ˆë‹¤.

ì´ë²ˆ ì‹œê°„ì—ëŠ” AWS Machine Learning Blogì— ì˜¬ë¼ì™€ ìˆëŠ” [í¬ìŠ¤íŠ¸ ì˜ˆì œ](https://aws.amazon.com/ko/blogs/machine-learning/extending-amazon-sagemaker-factorization-machines-algorithm-to-predict-top-x-recommendations/)ë¥¼ í†µí•´ SageMakerë¡œ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ì„ í›ˆë ¨, ë°°í¬ë¥¼ í•œ ê²½í—˜ì„ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤. CHAPTER 1 ì—ì„œëŠ” ë¨¸ì‹ ëŸ¬ë‹ì˜ ê¸°ë³¸ì ì¸ ê°œë…ì„ ê°„ë‹¨íˆ ì •ë¦¬í•˜ê³ , CHAPTER 2 ì—ëŠ” ì˜ˆì œ ì‹¤ìŠµì„ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ì— ëŒ€í•´ ê¸°ë³¸ ì§€ì‹ì´ ìˆìœ¼ì‹  ë…ìë¶„ì€ CHAPTER 2 ë¡œ ë°”ë¡œ ë„˜ì–´ê°€ì‹œë©´ ë©ë‹ˆë‹¤.

*(ì°¸ê³ . CHAPTER2 ì—ì„œëŠ” ì˜ˆì œì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ìœ¼ë¡œ ì§„í–‰ë˜ë©° ì½”ë“œ ì „ì²´ì— ëŒ€í•œ ì„¤ëª…ì€ ì§„í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)*

---

<a name="link2"></a>
## CHAPTER 1.

<a name="link3"></a>
### The Recommendation Problem

ì¶”ì²œì‹œìŠ¤í…œì€ ì‚¬ìš©ìê°€ í•­ëª©ì— ëŒ€í•´ í‰ê°€í•œ ê³¼ê±° ì„ í˜¸ë„*(ex. ë¦¬ë·°, ì°œ)*ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„ì§ ì‚¬ìš©í•˜ì§€ ì•Šì€ í•­ëª©ì— ëŒ€í•´ ì‚¬ìš©ìì˜ í‰ê°€ë¥¼ ì˜ˆì¸¡í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. ì‚¬ìš©ì u ê°€ í•­ëª© i ë¥¼ ì–¼ë§ˆë‚˜ ì¢‹ì•„í•  ê²ƒì¸ì§€ ë‚˜íƒ€ë‚´ëŠ” ê°’ì„ ë“±ê¸‰ Rui ë¼ê³  í–ˆì„ ë•Œ ë“±ê¸‰ ê°’ì€ í‰ì  ë°ì´í„°ì²˜ëŸ¼ 1ì—ì„œ 5ì‚¬ì´ì˜ ì‹¤ìˆ˜í˜• ë“±ê¸‰ ê°’ì¼ ìˆ˜ë„ ìˆê³ , í´ë¦­ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì´ì§„ ë“±ê¸‰ ê°’ì¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ ë•Œ í‰ì  ë°ì´í„°ëŠ” ëª…ì‹œì  ì ìˆ˜(Explicit Rating), í´ë¦­ ì—¬ë¶€ ë°ì´í„°ëŠ” ì•”ë¬µì  í”¼ë“œë°±(Implicit Feedback)ì´ë¼ê³  í•©ë‹ˆë‹¤.

ì„±ëŠ¥ì´ ì¢‹ì€ ì¶”ì²œì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” í•´ê²°í•˜ê³ ì í•˜ëŠ” ë¬¸ì œë¥¼ ì œëŒ€ë¡œ ì´í•´í•´ì•¼ í•˜ê³ , ëª…ì‹œì  ì ìˆ˜ ë° ì•”ë¬µì  í”¼ë“œë°±ì— ëŒ€í•œ ì„ íƒì„ í•´ì•¼ í•©ë‹ˆë‹¤.
<br /><br />

<a name="link4"></a>
### ëª…ì‹œì  ì ìˆ˜(Explicit Rating)

í›„ê¸° í‰ì ê³¼ ê°™ì´ ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì ìˆ˜ ë²”ìœ„ ì•ˆì—ì„œ ì‚¬ìš©ìê°€ ì§ì ‘ì ìœ¼ë¡œ ì ìˆ˜ì²™ë„ì— ê´€ì—¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì¶”ì²œ ì‹œìŠ¤í…œì— ëŒ€í•œ ì´ˆê¸° ì—°êµ¬ë“¤ì´ ëª…ì‹œì  ì ìˆ˜ì— ê¸°ë°˜í•˜ì—¬ ë§ì´ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëª…ì‹œì  ì ìˆ˜ëŠ” ê°ê´€ì ìœ¼ë¡œ ì²™ë„ë¥¼ íŒë‹¨í•˜ê¸° ì–´ë ¤ìš´ ë³€ìˆ˜ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ë§ˆìŒì— ë“œëŠ” ì˜·ì„ êµ¬ë§¤í–ˆë‹¤ê³  íŒë‹¨í–ˆì„ ë•Œ ëŒ€ë¶€ë¶„ì˜ ì‚¬ìš©ìëŠ” ë³„4ê°œ ë˜ëŠ” 5ê°œì˜ í›„í•œ ì ìˆ˜ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê·¸ì € ê·¸ëŸ° ì˜·ì´ë¼ê³  íŒë‹¨ë˜ì—ˆì„ ê²½ìš° ë³„1ê°œë„ ì•„ê¹Œì›Œì„œ ì•„ì˜ˆ ì ìˆ˜ë¥¼ ë§¤ê¸°ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì¦‰, ìƒí’ˆì— ëŒ€í•œ êµ¬ë§¤ ë°ì´í„° ëŒ€ë¹„ í‰ê°€ ë°ì´í„°ëŠ” ë§¤ìš° í¬ë°•í•©ë‹ˆë‹¤. ì´ê²ƒì„ ë¨¸ì‹ ëŸ¬ë‹ì—ì„œ ***í¬ì†Œ ë°ì´í„°***  ë˜ëŠ” ***í¬ì†Œí•˜ë‹¤(Sparse)*** ë¼ê³  í‘œí˜„í•©ë‹ˆë‹¤.
<br /><br />

<a name="link5"></a>
### ì•”ë¬µì  í”¼ë“œë°±(Implicit Feedback)

êµ¬ë§¤ì—¬ë¶€/ì¡°íšŒì—¬ë¶€ì²˜ëŸ¼ ëª…ì‹œì ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ì—†ëŠ” ë°ì´í„°ë“¤ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ëª…ì‹œì  ì ìˆ˜ì— ë¹„í•´ ì„ í˜¸ë„ë¥¼ ì œëŒ€ë¡œ í‘œí˜„í•  ìˆ˜ ì—†ë‹¤ëŠ” ë‹¨ì ì´ ìˆì§€ë§Œ, ì´ëŠ” ì•”ë¬µì  ì ìˆ˜ë¥¼ ì–´ë–»ê²Œ í•´ì„í•˜ëŠëƒì— ë”°ë¼ ì–´ëŠ ì •ë„ ê·¹ë³µì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. 

ì˜ˆë¥¼ ë“¤ì–´ íŠ¹ì • ìƒí’ˆì„ ì°œ í–ˆìœ¼ë©´ 1, ì•„ë‹ˆë©´ 0 ìœ¼ë¡œ êµ¬ë¶„í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì¶”ì²œí–ˆìœ¼ë‚˜ ì°œ í•˜ì§€ ì•Šì•˜ë‹¤ë©´ -1, ì¶”ì²œë˜ì§€ ì•Šì•˜ë‹¤ë©´ 0, ì°œì„ í–ˆë‹¤ë©´ 1 ê·¸ë¦¬ê³  êµ¬ë§¤ê¹Œì§€ í–ˆë‹¤ë©´ 2ì ì„ ë¶€ì—¬í•˜ëŠ” ì‹ìœ¼ë¡œ ë ˆì´íŒ…ì„ ë‹¬ë¦¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•”ë¬µì  í”¼ë“œë°±ì€ ëª…ì‹œì  ì ìˆ˜ ëŒ€ë¹„ ë°ì´í„° ìˆ˜ì§‘ì´ ì‰¬ìš°ë©° ì´ë¥¼ ***ë°€ì§‘ ë°ì´í„°***  ë˜ëŠ” ***ë°€ì§‘í•˜ë‹¤(Dense)*** ë¼ê³  í‘œí˜„í•©ë‹ˆë‹¤.
<br /><br />

<a name="link6"></a>
### ë¸Œëœë”” ì„œë¹„ìŠ¤ ì† ëª…ì‹œì  ì ìˆ˜ì™€ ì•”ë¬µì  í”¼ë“œë°± ğŸ§

{% include figure.html file="/assets/20200128/01.png" alt="sagemaker" width="fitcontent" caption="[ê·¸ë¦¼ 1] ëª…ì‹œì  ì ìˆ˜ (ìƒí’ˆì— ëŒ€í•œ Rating í‰ê°€)" %}<br />

{% include figure.html file="/assets/20200128/02.png" alt="sagemaker" width="fitcontent" caption="[ê·¸ë¦¼ 2] ì•”ë¬µì  í”¼ë“œë°± (ì°œí•œ ìƒí’ˆ, ìµœê·¼ ë³¸ ìƒí’ˆ)" %}
<br /><br />

<a name="link7"></a><a name="link8"></a>
## CHAPTER 2.

ì´ë²ˆ ì‹œê°„ì— ë‹¤ë£° ì˜ˆì œëŠ” Movielens ì˜ ì˜í™” í‰ì  ë°ì´í„° ì„¸íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ FM ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ íŠ¸ë ˆì´ë‹ í›„ KNN ì•Œê³ ë¦¬ì¦˜ì— ë§ê²Œ ë³€í™˜í•˜ì—¬ ìƒìœ„ Nê°œì˜ ì˜í™”ë¥¼ ì¶”ì²œí•´ì£¼ëŠ” ë‚´ìš©ì…ë‹ˆë‹¤. ì•ì„œ ë§í–ˆë“¯ í‰ì  ë°ì´í„°ëŠ” ëª…ì‹œì  ì ìˆ˜ì´ê¸° ë•Œë¬¸ì— Matrix Factorization ì•Œê³ ë¦¬ì¦˜ë³´ë‹¤ Sparse Dataì— ì í•©í•œ FM ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
<br />

ê·¸ëŸ¼ ì‹¤ì „ìœ¼ë¡œ ë°”ë¡œ ë“¤ì–´ê°€ë³¼ê¹Œìš”? ğŸƒâ€â™€ï¸
<br /><br />

2-1. ë¨¼ì € í•„ìš”í•œ ëª¨ë“ˆë“¤ì„ import í•©ë‹ˆë‹¤.

```python
import sagemaker
import sagemaker.amazon.common as smac
import numpy as np
import pandas as pd
import boto3
import io
import os

from sagemaker import get_execution_role
from sagemaker.predictor import json_deserializer
from sagemaker.amazon.amazon_estimator import get_image_uri
from scipy.sparse import lil_matrix
```
<br />
2-2. Movielens ì˜ ì˜í™” í‰ì  ë°ì´í„° ì„¸íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•œ í›„ ***ë°ì´í„° ì…”í”Œ [1]*** ì„ ì§„í–‰í•©ë‹ˆë‹¤.

```shell
# ë°ì´í„° ì„¸íŠ¸ ë‹¤ìš´ë¡œë“œ
!wget http://files.grouplens.org/datasets/movielens/ml-100k.zip
!unzip -o ml-100k.zip

# ë°ì´í„° ì…”í”Œ
!shuf ml-100k/ua.base -o ml-100k/ua.base.shuffled
```
<br />

---

*[1] íŠ¸ë ˆì´ë‹ ê²°ê³¼ê°€ 'ì‹¬í•œ ë¶ˆê· í˜•'ì„ ë³´ì´ì§€ ì•Šë„ë¡ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì˜í™”ì— ëŒ€í•´ ë¡œë§¨ìŠ¤ ì¹´í…Œê³ ë¦¬ â†’ ê³µí¬ ì¹´í…Œê³ ë¦¬ â†’ ì¶”ë¦¬ ì¹´í…Œê³ ë¦¬ ìˆœì„œë¡œ í•™ìŠµì„ ì‹œí‚¤ë©´, ë§¨ ì²˜ìŒ í•™ìŠµëœ ë¡œë§¨ìŠ¤ ì¹´í…Œê³ ë¦¬ì— ëŒ€í•´ì„œë§Œ ìµœì  ê°’ì„ ë°°ìš°ê²Œ ë˜ì–´ ê·¸ ë’¤ë¡œëŠ” íš¨ìœ¨ì´ ì—†ëŠ” í•™ìŠµì„ ì§„í–‰í•˜ê²Œ ë©ë‹ˆë‹¤. ë°”ë¡œ ì´ëŸ° í˜„ìƒì„ ë§‰ê¸° ìœ„í•´ ë°ì´í„°ë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ëŠ” ê²ƒì…ë‹ˆë‹¤.*

---
<br />

2-3. íŠ¸ë ˆì´ë‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

```python
# íŠ¸ë ˆì´ë‹ ë°ì´í„°ë¥¼ Pandas DataFrame ì— ë‹´ìŠµë‹ˆë‹¤.
user_movie_ratings_train = pd.read_csv(
  'ua.base.shuffled', 
  sep='\t', 
  index_col=False, 
  names=['user_id' , 'movie_id' , 'rating'],
)

# ìƒìœ„ 5ê±´ ë°ì´í„°ë¥¼ ì¶œë ¥ì‹œí‚µë‹ˆë‹¤.
user_movie_ratings_train.head(5)
```
<br />

2-4. í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

```python
# í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ Pandas DataFrame ì— ë‹´ìŠµë‹ˆë‹¤.
user_movie_ratings_test = pd.read_csv(
  'ua.test', 
  sep='\t', 
  index_col=False, 
  names=['user_id' , 'movie_id' , 'rating'],
)

# ìƒìœ„ 5ê±´ ë°ì´í„°ë¥¼ ì¶œë ¥ì‹œí‚µë‹ˆë‹¤.
user_movie_ratings_test.head(5)
```
<br />

2-5. ***FM íŠ¸ë ˆì´ë‹ ëª¨ë¸ [2]*** ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.

---

[2] *í˜„ì¬ AWS SageMakerì—ì„œ FM Algorithm ì…ë ¥ì— ëŒ€í•´ì„œëŠ” Float32 í…ì„œê°€ í¬í•¨ëœ recordIO-protobuf í˜•ì‹ë§Œ ì§€ì›í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì™ ì§€ ì–´ë ¤ì›Œë³´ì´ì§€ë§Œ Amazon SageMaker SDK ì—ì„œ ë³€í™˜ê¸°ëŠ¥ì„ ì œê³µí•´ì£¼ê¸° ë•Œë¬¸ì— ì „í˜€ ê±±ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.*

*ìš°ë¦¬ëŠ” FM ëª¨ë¸ë¡œ One-hot encodedëœ í¬ì†Œí–‰ë ¬(Sparse Matrix)ì„ ë§Œë“¤ ê²ƒì´ë©°, 4ì  ì´ìƒì˜ ë°ì´í„°ë§Œ ê³ ë ¤í•  ê²ƒì…ë‹ˆë‹¤.*<br />
*ê²°ê³¼ì ìœ¼ë¡œëŠ” 4ì  ì´ìƒë§Œ 1ì´ê³  ë‚˜ë¨¸ì§€ëŠ” 0ì¸ í¬ì†Œí–‰ë ¬ì´ ë§Œë“¤ì–´ ì§‘ë‹ˆë‹¤.*

---

```python
def loadDataset(dataframe, lines, columns):
    # (lines, columns) ëª¨ì–‘ì˜ ë¹ˆ í¬ì†Œ í–‰ë ¬ì„ ë§Œë“¤ê³  float32 íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    X = lil_matrix((lines, columns)).astype('float32')
    # ë ˆì´ë¸”ì˜ ì—¬ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.
    Y = []
    
    line=0
    for index, row in dataframe.iterrows():
        X[line,row['user_id']-1] = 1
        X[line, nb_users+(row['product_id']-1)] = 1
            
        # 4ì  ì´ìƒì˜ ë°ì´í„°ë§Œ ê³ ë ¤í•©ë‹ˆë‹¤.
        if int(row['rating']) >= 4:
            Y.append(1)
        else:
            Y.append(0)
            
            line=line+1

    Y=np.array(Y).astype('float32')            
    return X,Y
```
```python
nb_users = train_set['user_id'].max()
nb_products = train_set['product_id'].max()
nb_features = nb_users + nb_products

nb_ratings_test = len(user_product_ratings_test.index)
nb_ratings_train = len(user_product_ratings_train.index)

print ('# of users: ', nb_users)
print ('# of products: ', nb_products)
print ('Features (# of users + # of movies): ', nb_features)

print ('\nLoadDataset...')

X_train, Y_train = loadDataset(user_product_ratings_train, nb_ratings_train, nb_features)
X_test, Y_test = loadDataset(user_product_ratings_test, nb_ratings_test, nb_features)

print ('Success')
```
```python
assert X_train.shape == (nb_ratings_train, nb_features)
assert Y_train.shape == (nb_ratings_train, )

zero_labels = np.count_nonzero(Y_train)

print("Training labels: %d zeros, %d ones" % (zero_labels, nb_ratings_train-zero_labels))

assert X_test.shape == (nb_ratings_test, nb_features)
assert Y_test.shape == (nb_ratings_test, )

zero_labels = np.count_nonzero(Y_test)

print("Test labels: %d zeros, %d ones" % (zero_labels, nb_ratings_test-zero_labels))
```
<br />

ìœ„ ì½”ë“œë¥¼ ì°¨ë¡€ë¡œ ì‹¤í–‰í•œ í›„ì˜ ê²°ê³¼ë¥¼ ë³´ì‹œë©´ zero_labelsê°€ ì›”ë“±íˆ ë§ì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
Training labels: 3461 zeros, 538 ones
Test labels: 869 zeros, 133 ones
```
<br />

2-6. ***Protobuf íƒ€ì… [3]*** ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ S3ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.

---

[3] ì•ì„œ ë§í–ˆë“¯, SageMakerì— ë‚´ì¥ëœ FM ì•Œê³ ë¦¬ì¦˜ì€ protobuf í˜•ì‹ì˜ ë°ì´í„°ë§Œ ì…ë ¥ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” SageMaker SDKì—ì„œ ì œê³µí•˜ëŠ” ë©”ì†Œë“œë¥¼ ê°€ì§€ê³  protobufë¡œ ë³€í™˜, S3ë¡œ ì—…ë¡œë“œí•  ê²ƒì…ë‹ˆë‹¤.

---

```python
def writeDatasetToProtobuf(X, bucket, prefix, key, d_type, Y=None):
    buf = io.BytesIO()
    
    if d_type == 'sparse':
        smac.write_spmatrix_to_sparse_tensor(buf, X, labels=Y)
    else:
        smac.write_numpy_to_dense_tensor(buf, X, labels=Y)
        
    buf.seek(0)
    obj = '{}/{}'.format(prefix, key)
    boto3.resource('s3').Bucket(bucket).Object(obj).upload_fileobj(buf)
    
    return 's3://{}/{}'.format(bucket,obj)
```
```python
# ì—…ë¡œë“œ í•  ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
prefix = 'labs-fm'

train_key = 'train.protobuf'
train_prefix = '{}/{}'.format(prefix, 'train')

test_key = 'test.protobuf'
test_prefix = '{}/{}'.format(prefix, 'test')

output_prefix = 's3://{}/{}/output'.format(bucket, prefix)
```
```python
fm_train_data_path = writeDatasetToProtobuf(X_train, bucket, train_prefix, train_key, 'sparse', Y_train)    
fm_test_data_path  = writeDatasetToProtobuf(X_test, bucket, test_prefix, test_key, 'sparse', Y_test)    
  
print ('Training data S3 path: ',fm_train_data_path)
print ('Test data S3 path: ',fm_test_data_path)
print ('FM model output S3 path: {}'.format(output_prefix))
```
<br />

ìœ„ ì½”ë“œë¥¼ ì°¨ë¡€ë¡œ ì‹¤í–‰í•œ í›„ ì¶œë ¥ëœ S3ê²½ë¡œì— ì ‘ê·¼í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ protobuf íŒŒì¼ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% include figure.html file="/assets/20200128/03.png" alt="sagemaker" width="fitcontent" %}
<br />

2-7. ì¤€ë¹„ëœ ëª¨ë¸ì„ íŠ¸ë ˆì´ë‹í•©ë‹ˆë‹¤.

```python
# íŠ¸ë ˆì´ë‹ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì€ ì •í•´ì ¸ ìˆìœ¼ë©°, ê·¸ ì™¸ íƒ€ì…ì„ ì§€ì •í•  ê²½ìš° ValidationException ê°€ ë°œìƒí•©ë‹ˆë‹¤.
# ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì´ ë„ˆë¬´ ì‘ì„ ê²½ìš°ì—ëŠ” OutOfMemoryError ê°€ ë°œìƒí•˜ë¯€ë¡œ ì¤€ë¹„ëœ ëª¨ë¸ì˜ í¬ê¸°ë¥¼ ê³ ë ¤í•˜ì—¬ ì§€ì •í•©ë‹ˆë‹¤.
instance_type='ml.m5.large'

fm = sagemaker.estimator.Estimator(
  get_image_uri(boto3.Session().region_name, 'factorization-machines'),
  get_execution_role(), 
  train_instance_count=1, 
  train_instance_type=instance_type,
  output_path=output_prefix,
  sagemaker_session=sagemaker.Session(),
)

# í•„ìˆ˜ë¡œ ì ìš©í•´ì£¼ì–´ì•¼ í•˜ëŠ” í•˜ì´í¼íŒŒë¼ë¯¸í„°ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
fm.set_hyperparameters(
  feature_dim=nb_features,
  predictor_type='binary_classifier',
  num_factors=64,
)

# í›ˆë ¨ì„ ì‹œì‘í•©ë‹ˆë‹¤!
fm.fit(
  {
    'train': fm_train_data_path, 
    'test': fm_test_data_path
  }
)
```
<br />

2-8. ì´ì œ KNN ì•Œê³ ë¦¬ì¦˜ì— ë§ì¶° ëª¨ë¸ì„ ë¦¬íŒ¨í‚¤ì§•í•©ë‹ˆë‹¤.

```python
# ëª¨ë“ˆì´ ì—†ì„ ê²½ìš°ì—ëŠ” pip install ê³¼ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
import mxnet as mx

model_file_name = 'model.tar.gz'
model_full_path = fm.output_path +'/'+ fm.latest_training_job.job_name +'/output/'+model_file_name

print 'Model Path: ', model_full_path

# S3 ë²„í‚·ìœ¼ë¡œë¶€í„° FM ëª¨ë¸ì„ ë‹¤ìš´ë¡œë“œ í•©ë‹ˆë‹¤.
os.system('aws s3 cp '+model_full_path+ ' .')

# ëª¨ë¸ì„ ì¶”ì¶œí•˜ì—¬ MXNet ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
os.system('tar xzvf '+model_file_name)
os.system('unzip -o model_algo-1')
os.system('mv symbol.json model-symbol.json')
os.system('mv params model-0000.params')


m = mx.module.Module.load('./model', 0, False, label_names=['out_label'])
V = m._arg_params['v'].asnumpy()
w = m._arg_params['w1_weight'].asnumpy()
b = m._arg_params['w0_weight'].asnumpy()

# ì•„ì´í…œ ì ì¬ ë§¤íŠ¸ë¦­ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
knn_item_matrix = np.concatenate((V[nb_users:], w[nb_users:]), axis=1)
knn_train_label = np.arange(1,nb_movies+1)

# ì‚¬ìš©ì ì ì¬ ë§¤íŠ¸ë¦­ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
ones = np.ones(nb_users).reshape((nb_users, 1))
knn_user_matrix = np.concatenate((V[:nb_users], ones), axis=1)
```
<br /><br />

2-9. KNN ëª¨ë¸ì„ ì¤€ë¹„,ë°°í¬í•œ í›„ ë°°ì¹˜ ë³€í™˜ì„ í†µí•´ ì¶”ë¡  ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

{% include figure.html file="/assets/20200128/04.png" alt="sagemaker" width="fitcontent" caption="" %}
<br />

<a name="link9"></a>
## CONCLUSION

SageMakerëŠ” ë‚´ì¥í˜• Jupyter Notebook ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê³µí•´ì£¼ê¸° ë•Œë¬¸ì— ì„œë²„ ê´€ë¦¬ë¥¼ í•  í•„ìš”ì—†ì´ ì‰½ê²Œ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¿ë§Œ ì•„ë‹ˆë¼ AWS SDKë¥¼ í†µí•´ ëª¨ë¸ì„ ì‰½ê²Œ ë³€í™˜, í•™ìŠµ, ë°°í¬í•  ìˆ˜ ìˆìœ¼ë©° ì˜ˆì œì—ì„œëŠ” ë‹¤ë£¨ì§€ ì•Šì•˜ì§€ë§Œ ì˜ˆì¸¡ ê²°ê³¼ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì—¬ ìºì‹±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. 

ê°œì¸ì ìœ¼ë¡œ ë³¸ ê¸€ì„ ì¤€ë¹„í•˜ë©´ì„œ ë¨¸ì‹ ëŸ¬ë‹ì— ëŒ€í•œ ê¸°ë³¸ì ì¸ ì§€ì‹ê³¼ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•œ ì´í•´ë¥¼ ì¶©ë¶„íˆ í•˜ì§€ ëª»í•œ ì•„ì‰¬ì›€ì´ ìˆìŠµë‹ˆë‹¤. Movielensì˜ ì˜ˆì œ ìƒ˜í”Œ ë°ì´í„°ê°€ ì•„ë‹Œ ë¸Œëœë””ì˜ ìƒí’ˆ ë¦¬ë·° ë°ì´í„°ë¥¼ ë‹¤ë¤„ë³´ê³  ì‹¶ì—ˆì§€ë§Œ, íŠ¸ë ˆì´ë‹ ëª¨ë¸ì´ MXnet ëª¨ë“ˆì—ì„œ ì½í˜€ì§€ì§€ ì•Šê±°ë‚˜ ì›-í•« ì¸ì½”ë”© ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ë¶€ë¶„ì„ í•´ê²°í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤. ëª¨ë¸ì„ í›ˆë ¨, ë°°í¬í•˜ëŠ” ê³¼ì • ë˜í•œ ì‹œê°„ê³¼ í° ë¹„ìš©ì´ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ì›ì¸ì„ ì°¾ì•„ê°€ëŠ” ê³¼ì •ì€ ì‰½ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì´ë²ˆ ì‹œê°„ì„ í†µí•´ ë¨¸ì‹ ëŸ¬ë‹ì— ì¡°ê¸ˆ ê°€ê¹Œì›Œì§„ ê²ƒ ê°™ì•„ ë¿Œë“¯í•©ë‹ˆë‹¤!<br />
ì €ëŠ” ì•ìœ¼ë¡œ ì‹œê°„ì„ ë“¤ì—¬ ê¸°ë³¸ê¸°ë¥¼ ì¢€ ë” ë‹¤ì§„ í›„ ì¬ë„ì „ í•´ë³´ê² ìŠµë‹ˆë‹¤. ğŸ¤› í™”ì´íŒ…!

---

### ì°¸ê³  (2019ë…„ 12ì›” ê¸°ì¤€)

- í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤ì—ì„œ ëª¨ë¸ì„ ë°°í¬í•  ë•Œ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì„ 'ml.t2.medium' ì´ ì•„ë‹Œ ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ê²½ìš° ìì› ì´ˆê³¼ ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ë‹¤. 'ml.t2.medium' ìœ¼ë¡œëŠ” ìì›ì´ ë¶€ì¡±í•˜ì—¬ ë°°í¬ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ì—ˆìœ¼ë©°, AWS Support ë¡œ ë¬¸ì˜í•´ì•¼ í•˜ëŠ” ê²ƒìœ¼ë¡œ í™•ì¸í•˜ì˜€ë‹¤.

```python
ResourceLimitExceeded: An error occurred (ResourceLimitExceeded) when calling the CreateEndpoint operation: The account-level service limit 'ml.m5.2xlarge for endpoint usage' is 0 Instances, with current utilization of 0 Instances and a request delta of 1 Instances. Please contact AWS support to request an increase for this limit.
```


- ì°¸ê³ ë¬¸í—Œ

    [1] [https://aws.amazon.com/ko/blogs/machine-learning/extending-amazon-sagemaker-factorization-machines-algorithm-to-predict-top-x-recommendations/](https://aws.amazon.com/ko/blogs/machine-learning/extending-amazon-sagemaker-factorization-machines-algorithm-to-predict-top-x-recommendations/)

    [2] [https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/whatis.html](https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/whatis.html)

    [3] [https://zzaebok.github.io/machine_learning/factorization_machines/](https://zzaebok.github.io/machine_learning/factorization_machines/)
