I"~<h2 id="overview">Overview</h2>

<p><strong>ì˜¤ëŠ˜ì€ ë¸Œëœë””ì—ì„œ ì´ë¯¸ ì†Œê°œëœ ê¸°ìˆ ë“¤ì„ ê°„ë‹¨í•œ ë¯¸ì…˜ì„ í†µí•´ í™œìš©í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³¼ê¹Œ í•©ë‹ˆë‹¤.</strong></p>

<p>ë¸Œëœë””ëŠ” ìƒí’ˆ ì£¼ë¬¸ ë˜ëŠ” ì·¨ì†Œ, ë°°ì†¡ ìƒíƒœ ë“±ì— ë”°ë¼ ì‚¬ìš©ìì—ê²Œ ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€, SMS ë“± ê³ ê°ì—ê²Œ ì•Œë¦¼ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ, êµ­ë‚´ ì •ë³´í†µì‹ ë§ë²•ì— ë”°ë¼ ì•¼ê°„ ì‹œê°„ëŒ€(ì˜¤í›„ 9ì‹œ ~ ì˜¤ì „ 8ì‹œ ì‚¬ì´)ì—ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ì•Šì•„ì•¼ í•˜ë©°, ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ì„œëŠ” ë³„ë„ì˜ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. <a href="#link1" class="blue">[1]</a></p>

<p>ê·¸ë ‡ë‹¤ë©´ ë‹¹ì¥ í•´ì•¼ í•  ë¯¸ì…˜ì— ëŒ€í•´ ì§ì‘ì´ ê°€ì‹œë‚˜ìš”?</p>

<p><span class="blue">ë™ì˜ë¥¼ ë°›ì§€ ëª»í•œ ì•Œë¦¼ ì„œë¹„ìŠ¤ëŠ” ì•¼ê°„ ì‹œê°„ëŒ€ë¥¼ í”¼í•´ ì „ë‹¬í•˜ë¼.</span></p>

<p><span class="green">[ì‹œìŠ¤í…œ] ì§€ë ¹ì„ ìŠµë“í•˜ì˜€ìŠµë‹ˆë‹¤.</span></p>

<p><span class="red">ì‘?!?!</span></p>

<figure class="percent80">
  <img src="http://labs.brandi.co.kr///assets/2020/20201111/01.png" alt="sqs" />
</figure>
<figcaption></figcaption>

<p><br /><br /></p>

<h2 id="think">Think</h2>

<ol>
  <li>
    <p>ëŒ€ëŸ‰ ë©”ì‹œì§€ ë°œì†¡ì„ ìœ„í•´ ì„œë²„ ë¶€í•˜ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ë³´ë‚´ê¸° ìœ„í•œ ì €ì¥ì†Œì™€ ì‹¤í–‰ìê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

    <p>âœ”ï¸  SQS + Lambda í¬ìŠ¤íŒ… ì°¸ê³  <a href="#link2" class="blue">[2]</a></p>
  </li>
  <li>
    <p>ì•¼ê°„ ì‹œê°„ëŒ€ì— ë³´ë‚¸ ë©”ì‹œì§€ ì €ì¥ì†Œì™€ ì´ ë©”ì‹œì§€ë“¤ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ì‹¤í–‰ìê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

    <p>âœ”ï¸  ì´ê²ƒë„ SQS + Lambda í¬ìŠ¤íŒ… ì°¸ê³  <a href="#link2" class="blue">[2]</a></p>
  </li>
  <li>
    <p>ì•¼ê°„ ì‹œê°„ëŒ€ì— ëª¨ì—¬ì§„ ë©”ì‹œì§€ë“¤ì„, ë§¤ì¼ í•´ë‹¹ ì‹œê°„ëŒ€ë¥¼ í”¼í•´ ì „ì†¡í•˜ê¸° ìœ„í•´ ì‰¬ì§€ ì•ŠëŠ” ê¸°ê³„ì™€ ë©”ì‹œì§€ ì „ì†¡ì„ ìœ„í•œ ì‹¤í–‰ìê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

    <p>âœ”ï¸ CloudWatch í¬ìŠ¤íŒ… ì°¸ê³  <a href="#link3" class="blue">[3]</a></p>
  </li>
</ol>

<p><strong>í¬ìŠ¤íŒ…ì„ ì°¸ì¡°í•˜ì—¬ ê¸°ë³¸ì ìœ¼ë¡œ ìš”ì†Œë¥¼ êµ¬ì„± í–ˆë‹¤ë©´ ê·¸ë¦¼ì„ ê·¸ë¦¬ë©° í¼ì¦ì„ ë§ì¶”ì–´ ë´…ì‹œë‹¤.</strong>
<br /><br /></p>

<h2 id="architecturescedule-message-sqs">Architecture(Scedule Message SQS)</h2>

<figure class="percent80">
  <img src="http://labs.brandi.co.kr///assets/2020/20201111/02.jpg" alt="sqs" />
</figure>
<figcaption></figcaption>

<ul>
  <li>ë¯¸ì…˜ì€ ì•¼ê°„ ì‹œê°„ëŒ€ë¥¼ í”¼í•´ ëŒ€ëŸ‰ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ì•¼ í•˜ë©°, ì´ë¯¸ ë¸Œëœë”” ì•Œë¦¼ ì„œë¹„ìŠ¤ì—ì„œ ì¡´ì¬í•˜ëŠ” ë‹¨ì¼ ì „ì†¡, ì¼ê´„ ì „ì†¡ ê¸°ëŠ¥ì— ìµœëŒ€í•œ ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ì´ì— ë³„ë„ SQS(Schedule Message SQS)ë¥¼ êµ¬ì„±í•˜ì—¬ ê¸°ì¡´ SQSë¥¼ ë¶„ë¦¬ ì „ì†¡í•©ì‹œë‹¤.
<br /><br /></li>
</ul>

<h2 id="architecturewait-message-sqs">Architecture(Wait Message SQS)</h2>

<figure class="percent80">
  <img src="http://labs.brandi.co.kr///assets/2020/20201111/03.jpg" alt="sqs" />
</figure>
<figcaption></figcaption>

<ul>
  <li>ì•¼ê°„ ì‹œê°„ëŒ€ì— ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë³„ë„ ì €ì¥ì†Œì— ì €ì¥í•©ë‹ˆë‹¤.</li>
  <li>ì €ì¥ì†ŒëŠ” SQS ì™¸ Redis, Mongo DB ë“±ì„ ì´ìš©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.</li>
  <li>ë‹¤ë§Œ, í•„ìì˜ ê²½ìš° SQSê°€ ì›¹ UI ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ê°„í¸í•˜ë©° ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜ ì²˜ë¦¬ ë“±ì„ ì†ì‰½ê²Œ ì„¤ì • ê°€ëŠ¥í•˜ë©°, ë©”ì‹œì§€ ë³´ê´€ ë“±ì„ ë¹„ì¤‘ ìˆê²Œ ìƒê°í•˜ì—¬ ì„ íƒí–ˆìœ¼ë‹ˆ ìƒí™©ì— ë§ê²Œ ì„ íƒí•˜ì‹œë©´ ë©ë‹ˆë‹¤. ğŸ™‚
<br /><br /></li>
</ul>

<h2 id="architecturescheduling-sqs-messages">Architecture(Scheduling SQS messages)</h2>

<figure class="percent80">
  <img src="http://labs.brandi.co.kr///assets/2020/20201111/04.jpg" alt="sqs" />
</figure>
<figcaption></figcaption>

<ul>
  <li>ì•ì„œ êµ¬ì„±í•œ ê¸°ê³„(Cloud Watch)ì™€ ì‹¤í–‰ì(Schedule Lambda)ë¡œ SQSì— ìŒ“ì¸ ë©”ì‹œì§€ë“¤ì„ ì¡°ê¸ˆì”© ê°€ì ¸ì™€ Schedule Message SQSì— ë©”ì‹œì§€ë“¤ì„ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>í•˜ë‚˜ì˜ SQSë¥¼ êµ¬ì„±í•˜ì—¬ ë©”ì‹œì§€ ì „ì†¡ì„ í•´ë„ ë˜ê³ , ë©”ì‹œì§€ ì „ì†¡ ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ ê¸°ì¡´ SQSë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ë³„ë„ì˜ SQSë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒë„ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<p><strong>í¼ì¦ì„ ë§ì¶”ì—ˆë‹¤ë©´ ì´ì œ ì½”ë“œë¥¼ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.</strong>
<br /><br /></p>

<h2 id="code">Code</h2>

<ul>
  <li>scedule_manager/main.py : ìŠ¤ì¼€ì¤„ëŸ¬ ë©”ì¸</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: UTF-8 -*-
# from module.order_message import OrderMessage
# from module.refund_message import RefundMessage
# from module.delivery_message import DeliveryMessage
</span><span class="kn">from</span> <span class="nn">module.wait_message</span> <span class="kn">import</span> <span class="n">WaitMessage</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="n">sqs_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># OrderMessage(),
</span>    <span class="c1"># RefundMessage(),
</span>    <span class="c1"># DeliveryMessage()
</span>    <span class="n">WaitMessage</span><span class="p">()</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">handle</span><span class="p">():</span>

    <span class="n">send_result_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">sqs</span> <span class="ow">in</span> <span class="n">sqs_list</span><span class="p">:</span>
        <span class="n">send_result_map</span><span class="p">[</span><span class="n">sqs</span><span class="p">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">sqs</span><span class="p">.</span><span class="n">send</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">send_result_map</span><span class="p">)</span>
</code></pre></div></div>
<p><br /></p>

<ul>
  <li>scedule_manager/test.py : í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„œë²„ êµ¬ë™</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: UTF-8 -*-
</span><span class="s">"""
Examples:
    # ì„œë²„ êµ¬ë™
    python ./test.py
    # í…ŒìŠ¤íŠ¸ ë©”ì„¸ì§€ ì „ì†¡
    http://localhost:5000/send ì— POSTë¡œ SQSì— ë„£ì„ ë©”ì„¸ì§€ ì „ì†¡
"""</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">main</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/test'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">send</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">main</span><span class="p">.</span><span class="n">handle</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span>
</code></pre></div></div>
<p><br /></p>

<ul>
  <li>scedule_manager/requirements.txt : install í•­ëª©</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pymysql
jinja2
pytz
requests
slacker
boto3
Flask
</code></pre></div></div>
<p><br /></p>

<ul>
  <li>ê³µí†µ
<span class="indent">- scedule_manager/common/constant.py : ì „ì—­ë³€ìˆ˜</span></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
# ìŠ¤ì¼€ì¤„ëŸ¬ ë©”ì‹œì§€ ì¼ê´„ ì „ì†¡ SQS
</span><span class="n">SQS_QUEUE_URL_SCEDULE</span> <span class="o">=</span> <span class="s">'https://sqs.ap-northeast-1.amazonaws.com/9999999999/sqs_scedule_message'</span>
<span class="c1"># ì•¼ê°„ ì‹œê°„ëŒ€ì— ì „ì†¡ëœ ë©”ì‹œì§€ ì €ì¥ì†Œ SQS
</span><span class="n">SQS_QUEUE_URL_WAIT</span> <span class="o">=</span> <span class="s">'https://sqs.ap-northeast-1.amazonaws.com/9999999999/sqs_wait_message'</span>

<span class="n">SLACK_TOKEN</span> <span class="o">=</span> <span class="s">'xoxp-9999999999-9999999999-9999999999-999999999999999999999999999999'</span>
</code></pre></div></div>
<p><br /></p>

<ul>
  <li>ëª¨ë“ˆ
<span class="indent">- scedule_manager/module/wait_message.py : ëŒ€ê¸° ë©”ì‹œì§€ ì „ì†¡ SQS ëª¨ë“ˆ</span></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: UTF-8 -*-
</span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">constant</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">slack</span><span class="p">,</span> <span class="n">sqs</span>


<span class="c1">#############################
# ëŒ€ê¸° ë©”ì‹œì§€ ì „ì†¡ SQS ëª¨ë“ˆ
#############################
</span><span class="k">class</span> <span class="nc">WaitMessage</span><span class="p">:</span>
    <span class="n">schedule</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'08:00'</span><span class="p">:</span> <span class="p">{</span><span class="s">'usePeriod'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># ì´ë¦„
</span>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'WaitMessage SQS'</span>

    <span class="c1"># ì „ì†¡
</span>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'='</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'WaitMessage SQS Send Message!'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'='</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>

        <span class="c1"># ìŠ¤ì¼€ì¤„ ì‹œê°„ í™•ì¸
</span>        <span class="n">schedule_info</span> <span class="o">=</span> <span class="n">schedule</span><span class="p">.</span><span class="n">get_schedule_info</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">schedule_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'result'</span><span class="p">):</span>

            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ì¬ì „ì†¡ SQSì— íê°€ ë¹„ì›Œì§ˆë•Œê¹Œì§€ êº¼ë‚´ê³  SQS ë©”ì„¸ì§€ ì „ì†¡ í›„ ë©”ì„¸ì§€ ì‚­ì œ
</span>                <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">sqs</span><span class="p">.</span><span class="n">receive_after_delete</span><span class="p">(</span><span class="n">constant</span><span class="p">.</span><span class="n">SQS_QUEUE_URL_WAIT</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s">'Body'</span><span class="p">]:</span>
                        <span class="n">sqs</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">constant</span><span class="p">.</span><span class="n">SQS_QUEUE_URL_SCEDULE</span><span class="p">,</span> <span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">'Body'</span><span class="p">])))</span>
                        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"SQS Fail : {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">slack</span><span class="p">.</span><span class="n">send_slack_message</span><span class="p">(</span><span class="s">'Exception: {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="s">'SQS Fail!'</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s">'result'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'total'</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ì‹¤íŒ¨ì‹œ ì‹¤íŒ¨ ë©”ì‹œì§€ ë¦¬í„´
</span>            <span class="k">return</span> <span class="n">schedule_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'message'</span><span class="p">)</span>
</code></pre></div></div>
<p><br /></p>

<ul>
  <li>ìœ í‹¸
<span class="indent">- scedule_manager/utils/schedule.py : Util Schedule</span></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: UTF-8 -*-
</span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="kn">import</span> <span class="n">timezone</span>


<span class="k">def</span> <span class="nf">get_schedule_info</span><span class="p">(</span><span class="n">schedule</span><span class="p">):</span>
    <span class="s">"""ìŠ¬ë™ ë©”ì„¸ì§€ ì „ì†¡

    Args:
        schedule: json

    Returns:
        json

    """</span>
    <span class="c1"># now_date = datetime.datetime.now(timezone('Asia/Seoul'))  # í˜„ì¬ì‹œê°„
</span>    <span class="n">now_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># í…ŒìŠ¤íŠ¸ ì‹œê°„ì„¤ì •
</span>
    <span class="n">refine_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">now_date</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now_date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now_date</span><span class="p">.</span><span class="n">day</span><span class="p">,</span> <span class="n">now_date</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ì •ë¦¬ëœ ì‹œê°„
</span>    <span class="n">limit_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">now_date</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now_date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now_date</span><span class="p">.</span><span class="n">day</span><span class="p">,</span> <span class="n">now_date</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ìœ íš¨ ì‹œê°„
</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"now_date"</span><span class="p">:</span> <span class="n">now_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">),</span>
        <span class="s">"refine_date"</span><span class="p">:</span> <span class="n">refine_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">),</span>
        <span class="s">"limit_date"</span><span class="p">:</span> <span class="n">limit_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># ìœ íš¨ ì‹œê°„ ë„˜ì–´ê°€ë©´
</span>    <span class="k">if</span> <span class="n">now_date</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">limit_date</span><span class="p">.</span><span class="n">time</span><span class="p">():</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">refine_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="n">limit_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="s">"result"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"message"</span><span class="p">:</span> <span class="s">"ìœ íš¨ì‹œê°„ ë²”ìœ„ ["</span> <span class="o">+</span> <span class="n">startTime</span> <span class="o">+</span> <span class="s">" ~ "</span> <span class="o">+</span> <span class="n">endTime</span> <span class="o">+</span> <span class="s">"] ì´ˆê³¼"</span><span class="p">})</span>
    <span class="c1"># ìœ íš¨ ì‹œê°„ ì •ë³´ê°€ ì—†ìœ¼ë©´
</span>    <span class="k">elif</span> <span class="n">schedule</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">refine_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%H:%M"</span><span class="p">))</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">result</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="s">"result"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"message"</span><span class="p">:</span> <span class="s">"no match schedule"</span><span class="p">})</span>
    <span class="c1"># ì„±ê³µ
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="s">"result"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">schedule</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"usePeriod"</span><span class="p">):</span>
            <span class="n">schedule_info</span> <span class="o">=</span> <span class="n">schedule</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">refine_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%H:%M"</span><span class="p">))</span>
            <span class="n">result</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="s">"result"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">"info"</span><span class="p">:</span> <span class="n">schedule_info</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></div>
<p><br /></p>

<p><span class="indent2">- scedule_manager/utils/slack.py : Util Slack</span></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: UTF-8 -*-
</span><span class="kn">from</span> <span class="nn">slacker</span> <span class="kn">import</span> <span class="n">Slacker</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">constant</span>


<span class="k">def</span> <span class="nf">send_slack_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">incoming_webhook_url</span><span class="o">=</span><span class="s">'https://hooks.slack.com/services/TEST'</span><span class="p">):</span>
    <span class="s">"""ìŠ¬ë™ ë©”ì„¸ì§€ ì „ì†¡

    Args:
        incoming_webhook_url: slack webhook url
        message: ì „ë‹¬í•  ë©”ì„¸ì§€
        title: ë©”ì‹œì§€ íƒ€ì´í‹€ ì´ë¦„

    Returns:
        response or False

    """</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">constant</span><span class="p">.</span><span class="n">SLACK_TOKEN</span>

    <span class="n">slack</span> <span class="o">=</span> <span class="n">Slacker</span><span class="p">(</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="n">incoming_webhook_url</span><span class="o">=</span><span class="n">incoming_webhook_url</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span>
    <span class="p">)</span>
    <span class="n">attachments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">attachment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s">'fields'</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">'value'</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                <span class="s">'short'</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s">'mrkdwn_in'</span><span class="p">:</span> <span class="p">[</span><span class="s">'text'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">,</span> <span class="s">'fields'</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">attachments</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>
    <span class="n">slack_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'attachments'</span><span class="p">:</span> <span class="n">attachments</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">slack</span><span class="p">.</span><span class="n">incomingwebhook</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">slack_data</span><span class="p">)</span>
</code></pre></div></div>
<p><br /></p>

<p><span class="indent2">- scedule_manager/utils/sqs.py : Util SQS</span></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: UTF-8 -*-
</span><span class="kn">import</span> <span class="nn">boto3</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">queue_url</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="s">"""SQS ë©”ì„¸ì§€ ì „ì†¡

    Args:
        queue_url: SQS URL
        body : ì „ë‹¬í•  SQS Body

    Returns:
        response or False
    """</span>
    <span class="n">sqs_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sqs'</span><span class="p">,</span> <span class="s">'ap-northeast-1'</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">sqs_client</span><span class="p">.</span><span class="n">send_message</span><span class="p">(</span>
        <span class="n">QueueUrl</span><span class="o">=</span><span class="n">queue_url</span><span class="p">,</span>
        <span class="n">MessageBody</span><span class="o">=</span><span class="n">body</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span> <span class="nf">receive_after_delete</span><span class="p">(</span><span class="n">queue_url</span><span class="p">):</span>
    <span class="s">"""ì¬ì „ì†¡ SQSì— íê°€ ë¹„ì›Œì§ˆë•Œê¹Œì§€ êº¼ë‚´ê³  ë©”ì„¸ì§€ ì‚­ì œ

    Args:
        queue_url: SQS URL

    Returns:
        response or False
    """</span>

    <span class="n">sqs_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sqs'</span><span class="p">,</span> <span class="s">'ap-northeast-1'</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">sqs_client</span><span class="p">.</span><span class="n">receive_message</span><span class="p">(</span>
            <span class="n">QueueUrl</span><span class="o">=</span><span class="n">queue_url</span><span class="p">,</span>
            <span class="n">AttributeNames</span><span class="o">=</span><span class="p">[</span><span class="s">'All'</span><span class="p">],</span>
            <span class="n">MaxNumberOfMessages</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="k">from</span> <span class="n">resp</span><span class="p">[</span><span class="s">'Messages'</span><span class="p">]</span>
        <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s">'Id'</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s">'MessageId'</span><span class="p">],</span> <span class="s">'ReceiptHandle'</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s">'ReceiptHandle'</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s">'Messages'</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">sqs_client</span><span class="p">.</span><span class="n">delete_message_batch</span><span class="p">(</span>
            <span class="n">QueueUrl</span><span class="o">=</span><span class="n">queue_url</span><span class="p">,</span> <span class="n">Entries</span><span class="o">=</span><span class="n">entries</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s">'Successful'</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s">"Failed to delete messages: entries=</span><span class="si">{</span><span class="n">entries</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s"> resp=</span><span class="si">{</span><span class="n">resp</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">"</span>
            <span class="p">)</span>
</code></pre></div></div>
<p><br /><br /></p>

<p><strong>ì—¬ê¸°ì„œ ì ê¹! ì¶”ê°€ë¡œ í’€ì–´ë‚˜ê°€ì•¼ í•  ê³¼ì œê°€ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤!</strong></p>

<p>ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ê³ ê°ì´ ë§ì•„ì§€ë©´ í•œë²ˆì— ì „ì†¡í•´ì•¼ í•˜ëŠ” Wait Message SQSë„ ê·¸ë§Œí¼ ëŠ˜ì–´ë‚˜ê²Œ ë©ë‹ˆë‹¤. ë¬¼ë¡  Schedule Lambda ì œí•œ ì‹œê°„ ì•ˆì— ì™„ë£Œëœë‹¤ë©´ ë¬¸ì œê°€ ì—†ìœ¼ë‚˜, ì´ˆê³¼í•  ê²½ìš° ë‚¨ì•„ ìˆëŠ” MessageëŠ” ì–´ë–»ê²Œ í• ì§€ì— ëŒ€í•œ ê³ ë¯¼í•˜ê²Œ ë©ë‹ˆë‹¤. ê¸€ ì¤‘ê°„ì— ë©”ì‹œì§€ ì „ì†¡ ì†ë„ì— ëŒ€í•´ ì–¸ê¸‰í•˜ì—¬ ê·¸ëŸ¬í•œ ì¼ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ SQS ì¶”ê°€ êµ¬ì„±ì— ëŒ€í•´ ë§ì”€ë“œë ¸ëŠ”ë°ìš”. â€˜ë‚˜ëŠ” ì œí•œ ì‹œê°„ì— ì–½ë§¤ì´ëŠ” ê²Œ ì‹«ë‹¤!â€™ í•˜ì‹œëŠ” ë¶„ë“¤ì€ Batch êµ¬ì„±ì„ í•œë‹¤ë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
<br /><br /></p>

<h2 id="conclusion">Conclusion</h2>

<p>ì´ë²ˆ ì‹œê°„ì—ëŠ” Schedulingì„ í†µí•´ SQS ë©”ì‹œì§€ë¥¼ ëª¨ì•˜ë‹¤ê°€ ë‹¤ë¥¸ SQSë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì•„ì§ ê³ ë¯¼í•´ì•¼ í•  ì‚¬í•­ë“¤ì€ ì¡´ì¬í•˜ì§€ë§Œ, íŠ¹ì • ì¼ìì— ì „ë‹¬í•´ì•¼ í•˜ëŠ” ë°ì´í„°ë¥¼ ì‰½ê³  ë¹ ë¥´ê²Œ, ë”ë¶ˆì–´ ìœ ì§€ë³´ìˆ˜ë„ í¸í•˜ë„ë¡ ê°œë°œí•´ì•¼ í•  ë•Œ Amazon SQSë¥¼ ì´ìš©í•œ Scheduling ë°©ë²•ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.ğŸ™‚
<br /><br /></p>

<h2 id="reference">Reference</h2>

<p><a name="link1"></a>
1. ë¶ˆë²•ìŠ¤íŒ¸ëŒ€ì‘ì„¼í„° - ì•¼ê°„ì‹œê°„ëŒ€ì— ê´‘ê³ ì„± ì •ë³´ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆëŠ”ì§€?<br />
<a href="https://spam.kisa.or.kr/customer/sub3_R.do?idx=8" class="indent">https://spam.kisa.or.kr/customer/sub3_R.do?idx=8</a></p>

<p><a name="link2"></a>
2. SQS + Lambda - ì´ìƒê·¼ ì‹¤ì¥ë‹˜ ì‘ì„± ê¸€<br />
<a href="http://labs.brandi.co.kr/2018/02/16/leesg.html" class="indent">http://labs.brandi.co.kr/2018/02/16/leesg.html</a></p>

<p><a name="link3"></a>
3. CloudWatchì— ëŒ€í•˜ì—¬ - ê³½ì •ì„­ë‹˜ ì‘ì„± ê¸€<br />
<a href="http://labs.brandi.co.kr/2019/05/30/kwakjs.html" class="indent">http://labs.brandi.co.kr/2019/05/30/kwakjs.html</a></p>
:ET